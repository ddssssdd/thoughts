<% include head %>
<div  ng-app="ReadApp" ng-controller="ReadCtrl">
<nav class="navbar navbar-inverse navbar-fixed-top">
	<div class="container" >
		<div class="navbar-header">
			<a class="navbar-brand" href="/spiders/index">Home</a>
		</div>
		<div class="navbar-collapse collapse" role="navigation">
			<ul class="nav navbar-nav">
				<li>
					<a href="/spiders/add">Manage</a>
				</li>
				<li>
					<div class="dropdown" style="padding-top:15px;padding-bottom:15px;">
					  <a  id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
					    Chapters</a>
					  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="height:600px;overflow:scroll" id="chapter" >
					   <li ng-repeat="chapter in chapters" id="chapter_{{chapter.index}}" ng-click="select_chapter(chapter,$event);">
   							<a href='#index_{{chapter.index}}'>{{ ($index+1) + '. '+chapter.title }}</a>
   						</li>
					  </ul>
					</div>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="/spiders/settings">Settings</a>
				</li>
			</ul>
		</div>
	</div>
</nav>

<div class="container" style="font-size:16px;" id="top_container">
	<div class="row">
			<h2 class="text-center" ng-bind="book.title"></h2>
		</div>
	<div class="row">
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 ng-bind="current.title" class="text-center" ></h3>
			</div>
			<div class="panel-body" style="font-size:18px;line-height:30px;">
				<p ng-bind-html="html_content()">
			</div>
			<div class="panel-footer">
				<nav>
				  <ul class="pager">
				    <li class="previous"><a ng-click="goto_chapter(-1)" href="javascript:void(0);" ><span aria-hidden="true">&larr;</span> Prev</a></li>
				    <li class="next"  ><a href="javascript:void(0);" ng-click="goto_chapter(1)">Next <span aria-hidden="true">&rarr;</span></a></li>
				  </ul>
				</nav>
			</div>
		</div>
		<!-- div class="col-md-12" id="content" style="border:1px solid;font-size:18px;line-height:30px;padding-left:20px;">
			<p style="margin-top:30px;">
				<h3 ng-bind="current.title" class="text-center" ></h3>
			</p>
			<p ng-bind-html="html_content()">
			</p>
			<nav>
			  <ul class="pager">
			    <li class="previous" ng-click="goto_chapter(-1)"><a href="#" ><span aria-hidden="true">&larr;</span> Prev</a></li>
			    <li class="next"  ng-click="goto_chapter(1)"><a href="#">Next <span aria-hidden="true">&rarr;</span></a></li>
			  </ul>
			</nav>
		</div -->
	</div>
	<div class="row">
		<div class="progress">
	  	<div class="progress-bar" role="progressbar" aria-valuenow="{{progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{progress}}%;">
	    {{progress}}%
	  	</div>

		</div>
	</div>	
	<div class="row">
		
	</div>
</div>
</div>
<script>
	var app = angular.module("ReadApp",["commonService","ngSanitize","cfp.hotkeys"]);
	app.controller("ReadCtrl",function($scope,httpService,$sce,hotkeys){
		$scope.book_id = "<%= book_id %>";
		$scope.chapters = [];
		$scope.book ={};
		$scope.current = {};
		$scope.progress = 0;
		$scope.init_data = function(){
			$scope.load_data();
		}
		$scope.load_data = function(){
			var url = "/spiders/load_book/"+$scope.book_id;
			httpService(url,{},function(json){
				console.log(json);
				if (json.status){
					$scope.chapters = json.result;
					var current = json.chapter || json.result[0]
					$scope.select_chapter(current);	
					$scope.book  = json.book;
				}
				
			});

		}
		$scope.html_content = function(){
			return $sce.trustAsHtml($scope.current.content);
		}
		$scope.select_chapter = function(chapter,event){
			if (event) event.stopPropagation();
			var url = "/spiders/load_chapter/"+chapter._id;
			httpService(url,{},function(json){
				$scope.current = json;
				angular.element("#chapter li").removeClass("active");
				angular.element("#chapter_"+$scope.current.index).addClass("active");
				angular.element("#chapter").closest("div.dropdown").removeClass("open");
				$scope.progress = Math.ceil(100* (json.index / $scope.chapters.length) *100)/100; 
				location.href = "#top_container";
			});
		}
		$scope.goto_chapter = function(v){
			if (!$scope.current) return;
			var index = $scope.current.index + v;
			for(var i=0;i<$scope.chapters.length;i++){
				if ($scope.chapters[i].index==index){
					$scope.select_chapter($scope.chapters[i]);
					return;
				}
			}
		}
		$scope.init_data();
		hotkeys.bindTo($scope)
		.add({
			combo:"right",
			callback:function(){
				$scope.goto_chapter(1);
			}
		})
		.add({
			combo:"left",
			callback:function(){
				$scope.goto_chapter(-1);
			}
		});
	});
</script>
	
<% include footer %>
